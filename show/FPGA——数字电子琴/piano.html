<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>基于FPGA的数字电子琴</title>

<link rel="stylesheet" type="text/css" href="demo.css">

</head>
<body background="">
	<h2><center>基于FPGA的数字电子琴</center></h2>
		<section data-role="paragraph"><p style="text-align: justify; color:red; text-indent: 4em;">* 矩形键盘驱动设计 *<br><br></p></section>
            <p style="text-indent: 2em;">嵌入式设计中常见的键盘有两种类型，独立键盘与矩阵键盘，
独立式按键：每个按键单独连接到一个I/O口上，通过判断按键端口的电位识别按键的操作，编程简单，需要更多I/O资源。
矩阵式按键：通过行列交叉编码连接，通过分时扫描的方法识别按键的操作，节约I/O资源，编程相对复杂。
<br><br></p>
				
            <p style="text-indent: 2em;">● 优势：<br><br></p>

            	<section data-role="paragraph">
            		<p style="text-align: justify; text-indent: 2em;">关于独立键盘的驱动设计，我们在基础数字电路实验部分已经系统学习过，这里主要介绍一下矩阵键盘的原理及驱动方法。 在键盘中按键数量较多时，为了减少I/O口的占用，通常将按键排列成矩阵形式，使用行线和列线分别连接到按键开关的两端，这样我们就可以通过4根行线和4根列线（共8个I/O口）连接16个按键，而且按键数量越多优势越明显，比如再多加一条线就可以构成20键的键盘，而直接用端口线则只能多出一键（9键）。由此可见，在需要的键数比较多时，采用矩阵法来做键盘是更加合适的。<br><br></p>
            	<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">键盘采样功能程序实现如下：<br><br></p>         
			<p style="text-align: justify; text-indent: 2em;">always@(negedge clk_200hz or negedge rst_n_in) begin<br>	
            			<p style="text-align: justify; text-indent: 4em;">if(!rst_n_in) begin<br>
            				<p style="text-align: justify; text-indent: 6em;">key_out <= 16'hffff;<br>
            					<p style="text-align: justify; text-indent: 4em;">end else begin<br>
            						<p style="text-align: justify; text-indent: 6em;">case(c_state)<br>
										<p style="text-align: justify; text-indent: 8em;">STATE0:key_out[3:0] <= col;		//采集当前状态的列数据赋值给对应的寄存器位<br>
											<p style="text-align: justify; text-indent: 8em;">STATE1:key_out[7:4] <= col;<br>						
												<p style="text-align: justify; text-indent: 8em;">STATE2:key_out[11:8] <= col;<br>						
													<p style="text-align: justify; text-indent: 8em;">STATE3:key_out[15:12] <= col;<br>						
														<p style="text-align: justify; text-indent: 8em;">default:key_out <= 16'hffff;<br>						
            												<p style="text-align: justify; text-indent: 6em;">endcase<br>
            		    									    <p style="text-align: justify; text-indent: 4em;">end<br>
				  													<p style="text-align: justify; text-indent: 2em;">end<br>
			</p></section>

            	<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">下降沿检测程序实现如下：<br><br></p>         

            	<section data-role="paragraph"><p style="text-align: justify; text-indent: 0em;">reg		[15:0]		key_out_r;<br>
																								always @ ( posedge clk_in  or  negedge rst_n_in )<br>
																								if (!rst_n_in) key_out_r <= 16'hffff;<br>
																									else  key_out_r <= key_out;<br>
																								assign key_pulse= key_out_r & ( ~key_out);<br><br></p>         
            	<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">经过上面程序的处理，我们就得到了16位脉冲信号，平时为低电平，当按键被按下时刻key_pulse产生一个高脉冲，脉冲的宽度为模块系统时钟clk_in的一个周期。<br><br></p>         

				<section data-role="paragraph"><p style="text-align: justify; color:red; text-indent: 4em;">* 蜂鸣器驱动设计 *<br><br></p></section>

		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">脉冲宽度调制(PWM:Pulse Width Modulation)，简称脉宽调制。它是利用微控制器的数字输出调制实现，是对模拟电路进行控制的一种非常有效的技术，广泛应用于测量、通信、功率控制与变换等众多领域。<br><br></p>         

				<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">PWM周期转码程序实现如下：<br><br></p> 
				<section data-role="paragraph"><p style="text-align: justify; text-indent: 0em;">always@(key_in) begin<br>
																									case(key_in)<br>
																										16'h0001: cycle = 16'd45872;	//L1,<br>
																										16'h0002: cycle = 16'd40858;	//L2,<br>
																										16'h0004: cycle = 16'd36408;	//L3,<br>
																										16'h0008: cycle = 16'd34364;	//L4,<br>
																										16'h0010: cycle = 16'd30612;	//L5,<br>
																										16'h0020: cycle = 16'd27273;	//L6,<br>
																										16'h0040: cycle = 16'd24296;	//L7,<br>
																										16'h0080: cycle = 16'd22931;	//M1,<br>
																										16'h0100: cycle = 16'd20432;	//M2,<br>
																										16'h0200: cycle = 16'd18201;	//M3,<br>
																										16'h0400: cycle = 16'd17180;	//M4,<br>
																										16'h0800: cycle = 16'd15306;	//M5,<br>
																										16'h1000: cycle = 16'd13636;	//M6,<br>
																										16'h2000: cycle = 16'd12148;	//M7,<br>
																										16'h4000: cycle = 16'd11478;	//H1,<br>
																										16'h8000: cycle = 16'd10215;	//H2,<br>
																										default:  cycle = 16'd0;		//cycle为0，PWM占空比为0，低电平<br>
																									endcase<br>
																								end<br><br></p>         
				<section data-role="paragraph"><p style="text-align: justify; color:red; text-indent: 4em;">* 系统整体实现 *<br><br></p></section>
		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">本实验中简易电子琴在按键按下状态下一直发声，跟按键时间长短有关，这样我们就不能使用key_pulse了，而应该使用key_out信号，另外key_out按键有效输出为低电平，而PWM周期转码模块（tone）是高有效编码，所以在顶层模块（Electric_Piano）中矩阵键盘（Array_KeyBoard）与蜂鸣器音节驱动模块（Beeper）之间的key_out连线需要做按位取反操作。<br><br></p>         

		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">总体设计程序实现如下：<br><br></p>         

		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 0em;">Array_KeyBoard u1
																								(
																								.clk					(clk			),<br>
																								.rst_n				(rst_n			),<br>
																								.col					(col			),<br>
																								.row					(row			),<br>
																								.key_out				(key_out		),<br>
																								.key_pulse			(key_pulse		)<br>
																								);<br>
																								Beeper u2<br>
																								(
																								.clk					(clk			),<br>
																								.rst_n				(rst_n			),<br>
																								.key_out				(~key_out		),<br>
																								.beeper				(beeper			)<br>
																								);<br>
																								<br><br></p>         
		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">综合后的设计框图如图下图所示：<br><br></p>         
				<p style="text-align: center;"><img title="1560756109960164y0QM.jpg" style="" src="http://w3.sinaimg.cn/large/006Y5bsfly1g4bcsld8lhj30w00h3dh2.jpg"/></p>
		        <section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">Assignments → Pin_Planener,然后根据项目需求分配引脚，如图3.2所示：<br><br></p>         
				<p style="text-align: center;"><img title="1560756109960164y0QM.jpg" style="" src="http://w3.sinaimg.cn/large/006Y5bsfly1g4bcugolhdj30wq0h2mz6.jpg"/></p>
 				<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">引脚分配对照图3.3和图3.4完成分配问题<br><br></p>         
				<p style="text-align: center;"><img title="1560756109960164y0QM.jpg" width="600" height="258" align ="left" style="" src="http://w3.sinaimg.cn/large/006Y5bsfly1g4bcuzp6atj30kx090t98.jpg"/></p>
				<p style="text-align: right;"><img title="1560756109960164y0QM.jpg" width="600" height="258" style="" src="http://w3.sinaimg.cn/large/006Y5bsfly1g4bcuzp6atj30kx090t98.jpg"/></p>

 				<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">然后对设计整体编译并生成配置文件.sof文件；点击Tools → Programmer打开配置工具添加配置文件进行下载；程序到此烧录完成。按动矩阵按键听蜂鸣器发出的声音，16个按键对应16个音节。<br><br></p>         
				<p style="text-align: center;"><img title="1560756109960164y0QM.jpg" width="500" height="342" style="" src="http://w3.sinaimg.cn/large/006Y5bsfly1g4bcwl0fncj31ew0yuqv6.jpg"/></p>
				<section data-role="paragraph"><p style="text-align: justify; color:red; text-indent: 4em;">* 总结与展望 *<br><br></p></section>
 				<section data-role="paragraph"><p style="text-align: justify; text-indent: 2em;">通过这次课题设计，我们查阅了网上大量有关资料，与同学交流经验等方式，学到了不少知识。虽然经历了不少艰辛，但收获同样巨大，大大提高了动手的能力，充分体会到了在创造过程中探索的艰难和成功时的喜悦。虽然这个设计的功能并不完善，但是在设计过程中所学到的东西是这次课程设计的最大收获和财富，使我们终身受益。通过这次课程设计，不仅增强了我们的实践动手能力，也让我们对课堂上所学到的理论知识的理解加深了许多，这给我们提供了一个在学习生活中很难得的理论结合实际的机会。我们也会在今后的学习生活中多进行实践操作，积累经验以达到更好的效果。<br><br></p>         
				<section data-role="paragraph"><p style="text-align: justify; color:red; text-indent: 2em;">* 源代码下载 *<br><br>
				<p style="text-align: justify; text-indent: 2em;">CSDN下载链接：https://download.csdn.net/download/weixin_40928259/11255429<br><br></p>

</body>


